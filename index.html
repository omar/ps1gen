<!doctype html>

<html lang="en">
<head>
   <meta charset="utf-8" />
   <title>$PS1 Generator</title>
   <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css" />

   <style>

      body {
         background-image: url(shattered.png);
      }

      #title {
        color: #3a87ad;
      }

      li.draggable {
         display: inline-block;
         padding: 5px;
         border: solid 1px #ccc;
         border-radius: 5px;
         margin: 0  10px 10px 10px;
         text-align: center;
         position: relative;
         background-color: #f9f9f9;
      }

      li .hold {
         cursor: move;
         position: absolute;
         left: -6px;
         bottom: -6px;
      }

      li .delete {
         position: absolute;
         cursor: pointer;
         top: -6px;
         right: -6px;
      }

      #draggables .delete {
         display: none;
      }

      .dropdown-menu {
         text-align: left;
         min-width: auto;
      }

      .dropdown-menu li > a {
         padding: 3px 10px;
      }

      #sortable li.ui-sortable-placeholder {
         background-color: #d9edf7;
         border: dashed 1px #3a87ad;
         visibility: visible !important;
         
         margin: 0 10px;
         padding: 0;
      }

      a.dropdown-toggle {
         margin-top: 1px;
      }

      .draggable {

      }

      .popover-title {
         display: none;
      }

      .color-picker-add {
         display: inline-block;
      }

      .color-picker {
         width: auto;
      }

      #sortable {
         min-width:100px;
         min-height: 100px;
         border: dashed 2px #333;
      }

      #draggables, 
      #sortable {
         margin: 10px;
         padding: 5px;
      }

      .example {
         color: #c4c5c6;
         display: block;
         border-bottom: dashed 1px #ccc;
         margin-bottom: 3px;
      }

      .example input {
         margin: 0 0 2px 0;
         padding: 2px 4px;
      }

      .color-preview {
         width: 10px;
         height: 10px;
         display: inline-block;
      }

      .popover {
         width: 200px;
         font-size: 12px;
      }

      #preview,
      #output {
         background-color: #333;
         padding: 5px;
         margin: 0 5px;
         min-height: 20px;
      }

      #output {
         color: #f9f9f9;
      }

      #preview-background {
         margin: 0 0 5px 5px;         
      }

      .preview-example {
         color: #c4c5c6;
      }

      fieldset {
        margin: 0 0 10px 0;
      }

      footer {
        padding: 10px 0 20px 0;
      }

      .github-btns {
        vertical-align: middle;
      }
   </style>
</head>
<body>
  <div class="container">
    <h2 id="title">ps1gen <small>a PS1 generator and reference</small></h2>
    <iframe src="http://ghbtns.com/github-btn.html?user=omar&repo=ps1gen&type=watch&count=true"
  allowtransparency="true" frameborder="0" scrolling="0" width="100" height="20"></iframe>

      <iframe src="http://ghbtns.com/github-btn.html?user=omar&type=follow"
  allowtransparency="true" frameborder="0" scrolling="0" width="200" height="20"></iframe>

    <fieldset>
      <legend>Options <small>- drag items from here to the 'Selected' area</small></legend>
      <ul id="draggables">
          <li class="draggable new-item">
            <i class="icon-remove delete"></i>
            <span class="example">
              <input type="text" class="input-mini" />
            </span>
            <i class="icon-move hold"></i>
            <a href="#" class="btn btn-mini pop-it" data-content="Enter custom text">txt</a>
            <div class="color-picker-add"></div>
          </li>

      </ul>
    </fieldset>

    <fieldset id="selected">
      <legend>Selected <small>- items placed here will be used to generate the PS1 string</small></legend>
      <ul id="sortable">
      </ul>
    </fieldset>

    <fieldset>
      <legend>Preview <small>- what your command prompt will look like</small></legend>
      <div id="preview-background">
        <span>Background</span>
         <div class="btn-group">
            <a href="#" class="btn btn-small active" data-color="#333">Dark</a>
            <a href="#" class="btn btn-small" data-color="#fff">Light</a>
         </div>
      </div>
      <p id="preview"></p>
    </fieldset>

    <fieldset>
      <legend>Output <small>- the PS1 string that matches the items selected</small></legend>
      <p id="output"></p>
    </fieldset>

    <fieldset>
      <legend>References</legend>

      <ul>
        <li><a href="http://www.gnu.org/software/bash/manual/bashref.html#Printing-a-Prompt">bash manual: Controlling the Prompt</a> (gnu.org)</li>
        <li><a href="http://www.ibm.com/developerworks/library/l-tip-prompt/">Tip: Prompt magic</a> (ibm.com)</li>
      </ul>
    </fieldset>

    <hr />

    <footer>
      by Omar Khudeira | <a href="http://omar.io">omar.io</a> | <a href="http://github.com/omar">github.com/omar</a>
    </footer>
  </div>

  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
  <script src="bootstrap/js/bootstrap.min.js"></script>
  <script src="underscore-min.js"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.0/jquery-ui.min.js"></script>
  
  <script type="text/template" id="item-template">
      <li class="draggable new-item">
        <i class="icon-remove delete"></i>
        <span class="example">{{ example }}</span>
        <i class="icon-move hold"></i>
        <a href="#" class="btn btn-mini pop-it" data-content="{{ description }}">{{ text }}</a>
        <div class="color-picker-add"></div>
      </li>
  </script>

  <script type="text/template" id="color-template">
  <div class="btn-group">
    <a class="btn btn-mini dropdown-toggle" data-toggle="dropdown" href="#">
      <span class="color-preview" style="background-color: #c4c5c6" data-code="37m"></span>
    </a>
    <ul class="dropdown-menu">
      {[ _.each(colors, function (color) { ]}
        <li>
          <a href="#" class="color-pick">
            <span class="color-preview" style="background-color:{{ color.hex }}" data-code="{{ color.code }}"></span>
            {{ color.text }}
          </a>
        </li>
      {[ }); ]}
    </ul>
  </div>
  </script>

  <script>

    var symbolsTable = [
      ['\\d', 'Date in "Weekday Month Date" format', 'Tue May 26'],
      ['\\h', 'Hostname, up to the first \'.\'', 'mybox'],
      ['\\H', 'Hostname', 'mybox.mydomain.com'],
      ['\\t', 'Time in 24-hour HH:MM:SS format', '23:01:01'],
      ['\\T', 'Time in 12-hour HH:MM:SS format', '11:01:01'],
      ['\\@', 'Time in 12-hour format with am/pm', '11:01:01 AM'],
      ['\\u', 'Username of current user', 'omar'],
      ['\\w', 'Current working directory, with $HOME abbreviated with a tilde (uses the $PROMPT_DIRTRIM variable)', '~'],
      ['\\W', 'Basename of the current working directory ', '~'],
      ['\\#', 'Command number (this will count up at each prompt, as long as you type something)', '5']
    ];

    var symbols = (function() {
      var items = [];

      for(var i in symbolsTable) {
        var symbol = symbolsTable[i];
        var text = symbol[0];
        var description = symbol[1].replace(/"/g, "'");
        var example = symbol[2];

        var item = {
          text: text,
          description: description,
          example: example
        };

        items.push(item);
      }

      return items;
    })();

    var colorsTable = [
      ['Gray', '37m', '#c4c5c6'],
      ['Black', '30m', '#000'],
      ['Red', '31m', '#ba2f1e'],
      ['Green', '32m', '#22b421'],
      ['Yellow', '33m', '#a4a423'],
      ['Blue' , '34m', '#3f2add'],
      ['Pink' , '35m', '#cd31cd'],
      ['Cyan', '36m', '#2db2c1']
    ];

    var colors = (function() {
      var items = [];

      for(var i in colorsTable) {
        var color = colorsTable[i];
        var text = color[0];
        var code = color[1];
        var hex = color[2];

        var item = {
          text: text,
          code: code,
          hex: hex
        };

        items.push(item);
      }

      return items;
    })();

    _.templateSettings = {
      evaluate : /\{\[([\s\S]+?)\]\}/g,
      interpolate : /\{\{(.+?)\}\}/g
    };

    $(document).ready(function() {
      populateItems();

      $( "#sortable" ).sortable({
        revert: true,
        stop: function () {
         updateOutput();
        }
      });
      $( "#draggables li" ).draggable({
        connectToSortable: "#sortable",
        helper: "clone",
        revert: "invalid",
        cursorAt: { left: 0 },
        stop: function() {
          bindClicks();
          bindTextChange();
          updateOutput();
          $('.pop-it').popover(popoverOptions);
        }
      });
      $( "ul, li" ).disableSelection();

      var popoverOptions = {
        placement: 'bottom'
      };

      $('.pop-it').popover(popoverOptions);

      $('.color-picker-add').replaceWith(colorsDropdown);
      bindClicks();
    });

    var populateItems = function() {
      var template = _.template($('#item-template').html());

      var html = '';
      for(var i in symbols) {
        html += template(symbols[i]);
      }

      $('#draggables').prepend(html);
    };

    var colorsDropdown = (function() {
      var template = _.template($('#color-template').html());
      var html = template({ colors: colors });
      return html;
    })();

    var bindClicks = function() {
      $('a.color-pick').on('click', function (e) {
        var $this = $(this);
        var color = $this.find('.color-preview').css('background-color');
        var code = $this.find('.color-preview').attr('data-code');

        $this.parents('.new-item').find('.example, .example input').css('color', color);
        $this.parents('.btn-group').find('.dropdown-toggle .color-preview').css('background-color', color);
        $this.parents('.btn-group').find('.dropdown-toggle .color-preview').attr('data-code', code);
        $this.parents('ul').find('li').removeClass('active');
        $this.parent('li').addClass('active');

        updateOutput();
        e.preventDefault(); 
        return true;
      });

      $('a.pop-it').on('click', function(e) {
        e.preventDefault(); 
        return true;
      });

      $('.delete').click(function(e) {
        $(this).parent('li').remove();
        updateOutput();
        e.preventDefault(); 
        return true;
      });

      $('#preview-background a').click(function(e) {
         $('#preview-background a').removeClass('active');
         var $this = $(this);
         $this.toggleClass('active');
         $('#preview').css('background-color', $this.data('color'));
         e.preventDefault(); 
         return true;
      });
    };

    var bindTextChange = function() {
      $('#selected .example input').on('keyup', function() {
        updateOutput();
      });
    };

    var parseSelectedItems = function() {
      var items = [];

      var text = '';
      var preview = '';
      var $selected = $('#sortable li.new-item:not(.ui-sortable-placeholder)');
      if($selected.size() == 0)
        return {
          text: '',
          preview: '',
          items: []
        };

      $selected.each(function (index) {
        var $this = $(this);
        var code = $this.find('.dropdown-toggle .color-preview').attr('data-code');
        
        var symbol = $this.find('.pop-it').text();
        var $clone = $this.find('.example').clone().attr('class', 'preview-example');

        if(symbol === 'txt') {
          symbol = $this.find('input').val();
          symbol = symbol.replace(/"/g, '\\"')
                         .replace(/\\/g, '\\\\');
          $clone.html($clone.find('input').val());
        }
          
        preview += $clone[0].outerHTML + " ";  
        text += '\\e[0;' + code + symbol + " ";
        
        var item = {
          code: code,
          symbol: symbol
        };
        items.push(item);
      });

      text += '\\e[0m ';

      var result = {
        text: text,
        preview: preview,
        items: items
      };

      return result;
    };

    var updateOutput = function() {
      var result = parseSelectedItems();
      $('#preview').html(result.preview);
      $('#output').html(result.text);
    };
  </script>
</body>
</html>